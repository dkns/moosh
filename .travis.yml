language: php

php:
  - 5.5

mysql:
  database: moodle
  username: root
  encoding: utf8

env:
  - DB=mysqli

before_install:
  - curl -sS https://getcomposer.org/installer | php
  - sudo apt-get update > /dev/null
  - sudo apt-get install apache2 libapache2-mod-fastcgi
  - sudo service apache2 restart
  - git clone https://github.com/moodle/moodle.git moodle
  - cd moodle
  - cp config-dist.php config.php
  - sh -c "sed -i -e s/'password'/''/ -e s/example.com/localhost/ -e s%/home/example%$HOME% -e 's%\(\$CFG.*phpu\)%\n\1%' config.php"
  - sh -c "if [ '$DB' = 'mysqli' ]; then mysql -e 'create database moodle default character set UTF8 collate UTF8_bin;'; fi"
  - sh -c "if [ '$DB' = 'mysqli' ]; then sed -i -e s/\'pgsql\'/\'mysqli\'/ -e s/\'username\'/\'root\'/ config.php; fi"
  - sh -c "if [ '$DB' = 'pgsql' ]; then psql -c 'create database moodle;' -U postgres; fi"
  - sh -c "if [ '$DB' = 'pgsql' ]; then sed -i s/\'username\'/\'postgres\'/ config.php; fi"
  - cd $HOME
  - sudo mkdir -m777 ../moodledata

install:
  - cd moodle/admin/cli
  - sudo -u www-data php install.php --agree-license --allow-unstable --non-interactive --lang=en --dbtype=mysqli --dbhost=127.0.0.1 --dbname=moodle --dbuser=root --wwwroot=http://localhost/moodle --dataroot=/home/travis/build/dkns/moodledata --fullname=test --shortname=test --adminuser=test --adminpass=Test1234! --adminemail=test@example.com
   - cd ../..
   - sudo chown -R root moodle
  # - ./composer.phar install

script: bash tests/commands/user-create.sh
